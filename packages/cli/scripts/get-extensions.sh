#!/bin/bash

set -euo pipefail

mkdir -p ./gen

EXTENSION_FILE="dx.yml"

KNOWN_EXTENSIONS_FILE="./gen/known-extensions.yml"

MAIN_CWD="$(pwd)"

EXEC_JS_YML=$MAIN_CWD/node_modules/.bin/js-yaml
EXEC_JSON2YML=$MAIN_CWD/node_modules/.bin/json2yaml
EXEC_JQ=$MAIN_CWD/node_modules/node-jq/bin/jq

EXTENSIONS="["

#
# Read all extension definition YML files from all known modules.
#
for extensiondir in `find ../ -name 'cli-*' -type d | grep -v node_modules | sort`; do
  pushd $extensiondir

  EXT_FILE_PATH=`find . -name $EXTENSION_FILE -not -path "./dist/*"`
  if [ -f "$EXT_FILE_PATH" ]; then
    # $MAIN_CWD/node_modules/.bin/js-yaml $EXTENSION_FILE
    if [ "$EXTENSIONS" != "[" ]; then
      EXTENSIONS+=","
    fi

    # Read extension definition YML file.
    EXTENSIONS+=` $EXEC_JS_YML $EXTENSION_FILE`
  fi

  popd
done

EXTENSIONS+="]"

echo "# This is an autogenerated file. Do not edit this file directly." > $KNOWN_EXTENSIONS_FILE
echo $EXTENSIONS |
  $EXEC_JQ '[.[] | { moduleName:.moduleName, description: .description, modules: .modules }]' |
  $EXEC_JSON2YML >> $KNOWN_EXTENSIONS_FILE
